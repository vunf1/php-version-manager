name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.1.0, v1.2.3, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to create release for (e.g., v0.1.2)'
        required: true

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'phpvm-core -> target, phpvm-gui/src-tauri -> target'

      - name: Install dependencies
        working-directory: phpvm-gui
        run: npm install

      - name: Generate icon files
        working-directory: phpvm-gui
        run: |
          # Generate missing PNG icon files if needed (Windows build)
          cd src-tauri/icons
          python -c "import struct, zlib, os; 
          def create_png(size, filename):
              png = b'\x89PNG\r\n\x1a\n'
              ihdr_data = struct.pack('>II', size, size) + b'\x08\x06\x00\x00\x00'
              crc = zlib.crc32(b'IHDR' + ihdr_data) & 0xffffffff
              png += struct.pack('>I', len(ihdr_data)) + b'IHDR' + ihdr_data + struct.pack('>I', crc)
              idat_data = b'\x00' * (size * size * 4 + size)
              idat_compressed = zlib.compress(idat_data)
              crc = zlib.crc32(b'IDAT' + idat_compressed) & 0xffffffff
              png += struct.pack('>I', len(idat_compressed)) + b'IDAT' + idat_compressed + struct.pack('>I', crc)
              png += b'\x00\x00\x00\x00IEND\xaeB`\x82'
              with open(filename, 'wb') as f: f.write(png)
          def is_valid_png(filename):
              try:
                  with open(filename, 'rb') as f: return f.read(8)[:4] == b'\x89PNG'
              except: return False
          for size, name in [(256, 'icon.png'), (32, '32x32.png'), (128, '128x128.png'), (256, '128x128@2x.png')]:
              if not os.path.exists(name) or not is_valid_png(name):
                  create_png(size, name)
                  print(f'Generated {name}')"

      - name: Build core library
        working-directory: phpvm-core
        run: cargo build --release

      - name: Build Tauri app (Windows)
        working-directory: phpvm-gui
        run: npm run tauri build

      - name: List bundle directory contents (Windows)
        working-directory: phpvm-gui
        run: |
          echo "Checking bundle directory structure..."
          if (Test-Path ..\target\release\bundle) {
            Get-ChildItem -Path ..\target\release\bundle -Recurse -File | Select-Object FullName, Length
          } else {
            echo "Bundle directory not found"
          }
          echo ""
          echo "Looking for .msi files:"
          Get-ChildItem -Path ..\target\release\bundle -Recurse -Filter *.msi -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }
          echo ""
          echo "Looking for .exe files in nsis:"
          Get-ChildItem -Path ..\target\release\bundle -Recurse -Filter *.exe -ErrorAction SilentlyContinue | Where-Object { $_.DirectoryName -like "*nsis*" } | ForEach-Object { $_.FullName }

      - name: Upload Windows artifacts
        working-directory: phpvm-gui
        run: |
          # Create artifacts directory
          New-Item -ItemType Directory -Force -Path "artifacts/windows" | Out-Null
          
          # Get version from package.json
          $version = (Get-Content package.json | ConvertFrom-Json).version
          $standaloneName = "PHP Version Manager_${version}_x64.exe"
          
          # Copy standalone executable and rename it
          if (Test-Path "..\target\release\phpvm-gui.exe") {
            Copy-Item "..\target\release\phpvm-gui.exe" -Destination "artifacts/windows\$standaloneName" -Force
            Write-Host "Copied standalone executable: $standaloneName"
          } else {
            Write-Host "Standalone executable not found"
          }
          
          # Copy MSI files
          if (Test-Path "..\target\release\bundle\msi\*.msi") {
            Copy-Item "..\target\release\bundle\msi\*.msi" -Destination "artifacts/windows/" -Force
            Get-ChildItem "artifacts/windows/*.msi" | ForEach-Object { Write-Host "Copied: $($_.Name)" }
          } else {
            Write-Host "No MSI files found"
          }
          
          # Copy NSIS installer files
          if (Test-Path "..\target\release\bundle\nsis\*.exe") {
            Copy-Item "..\target\release\bundle\nsis\*.exe" -Destination "artifacts/windows/" -Force
            Get-ChildItem "artifacts/windows/*-setup.exe" | ForEach-Object { Write-Host "Copied: $($_.Name)" }
          } else {
            Write-Host "No NSIS installer files found"
          }
          
          # List all files ready for upload
          Write-Host "Files ready for upload:"
          Get-ChildItem "artifacts/windows" -File | ForEach-Object { Write-Host "  - $($_.Name)" }
      
      - name: Upload Windows artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: phpvm-gui/artifacts/windows/*
          retention-days: 30
          if-no-files-found: warn

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'phpvm-core -> target, phpvm-gui/src-tauri -> target'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install dependencies
        working-directory: phpvm-gui
        run: npm install

      - name: Generate icon files
        working-directory: phpvm-gui
        run: |
          cd src-tauri/icons
          chmod +x generate-icons.sh
          ./generate-icons.sh
          # Verify all required icon files exist
          for icon in icon.png 32x32.png 128x128.png 128x128@2x.png; do
            if [ ! -f "$icon" ]; then
              echo "Error: Required icon file $icon was not generated!"
              exit 1
            fi
            echo "‚úì $icon exists ($(stat -c%s "$icon") bytes)"
          done

      - name: Build core library
        working-directory: phpvm-core
        run: cargo build --release

      - name: Build Tauri app (Linux)
        working-directory: phpvm-gui
        run: npm run tauri build

      - name: List bundle directory contents
        working-directory: phpvm-gui
        run: |
          echo "Checking bundle directory structure..."
          find ../target/release/bundle -type f 2>/dev/null || echo "Bundle directory not found or empty"
          echo ""
          echo "Looking for AppImage files:"
          find ../target/release/bundle -name "*.AppImage" 2>/dev/null || echo "No AppImage files found"
          echo ""
          echo "Looking for .deb files:"
          find ../target/release/bundle -name "*.deb" 2>/dev/null || echo "No .deb files found"
          echo ""
          echo "Looking for .rpm files:"
          find ../target/release/bundle -name "*.rpm" 2>/dev/null || echo "No .rpm files found"

      - name: Prepare Linux artifacts
        working-directory: phpvm-gui
        run: |
          # Create artifacts directory
          mkdir -p artifacts/linux
          
          # Copy AppImage files
          if find ../target/release/bundle/appimage -name "*.AppImage" -type f 2>/dev/null | head -1 | grep -q .; then
            cp ../target/release/bundle/appimage/*.AppImage artifacts/linux/ 2>/dev/null || true
            echo "Copied AppImage files"
          else
            echo "No AppImage files found"
          fi
          
          # Copy .deb files
          if find ../target/release/bundle/deb -name "*.deb" -type f 2>/dev/null | head -1 | grep -q .; then
            cp ../target/release/bundle/deb/*.deb artifacts/linux/ 2>/dev/null || true
            echo "Copied .deb files"
          else
            echo "No .deb files found"
          fi
          
          # Copy .rpm files
          if find ../target/release/bundle/rpm -name "*.rpm" -type f 2>/dev/null | head -1 | grep -q .; then
            cp ../target/release/bundle/rpm/*.rpm artifacts/linux/ 2>/dev/null || true
            echo "Copied .rpm files"
          else
            echo "No .rpm files found"
          fi
          
          # List all files ready for upload
          echo "Files ready for upload:"
          ls -lh artifacts/linux/ || echo "No files in artifacts/linux/"
      
      - name: Upload Linux artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: phpvm-gui/artifacts/linux/*
          retention-days: 30
          if-no-files-found: warn

  create-release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION_NUMBER="${VERSION#v}"
          
          # Generate changelog from commits
          if git describe --tags --abbrev=0 HEAD~1 2>/dev/null; then
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1)
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          
          # Build release notes in RELEASE_NOTES.md format
          NOTES="# Release Notes\n\n"
          NOTES="${NOTES}## Version ${VERSION_NUMBER}\n\n"
          NOTES="${NOTES}### üéâ Overview\n\n"
          NOTES="${NOTES}Release ${VERSION_NUMBER} of PHP Version Manager, a cross-platform tool for managing multiple PHP versions with a modern graphical interface.\n\n"
          NOTES="${NOTES}### üì¶ Installation\n\n"
          NOTES="${NOTES}**Windows (64-bit)**\n\n"
          NOTES="${NOTES}Two installer options are available:\n\n"
          NOTES="${NOTES}- **MSI Installer**: \`PHP Version Manager_${VERSION_NUMBER}_x64_en-US.msi\`\n"
          NOTES="${NOTES}  - Recommended for enterprise deployments\n"
          NOTES="${NOTES}  - Supports silent installation\n"
          NOTES="${NOTES}  - Integrates with Windows Installer service\n\n"
          NOTES="${NOTES}- **Setup Executable**: \`PHP Version Manager_${VERSION_NUMBER}_x64-setup.exe\`\n"
          NOTES="${NOTES}  - User-friendly installation wizard\n"
          NOTES="${NOTES}  - Includes automatic dependency checks\n"
          NOTES="${NOTES}  - Standard Windows installer experience\n\n"
          NOTES="${NOTES}**Linux**\n\n"
          NOTES="${NOTES}- **AppImage**: Download the \`.AppImage\` file, make it executable (\`chmod +x\`), and run it\n"
          NOTES="${NOTES}- **Debian/Ubuntu**: Install the \`.deb\` package with \`sudo dpkg -i *.deb\`\n"
          NOTES="${NOTES}- **Fedora/RHEL**: Install the \`.rpm\` package with \`sudo rpm -i *.rpm\` or \`sudo dnf install *.rpm\`\n\n"
          NOTES="${NOTES}### ‚ú® What's New\n\n"
          if [ -n "$CHANGELOG" ]; then
            NOTES="${NOTES}${CHANGELOG}\n\n"
          else
            NOTES="${NOTES}See commit history for detailed changes.\n\n"
          fi
          NOTES="${NOTES}### üõ†Ô∏è System Requirements\n\n"
          NOTES="${NOTES}**Windows:**\n"
          NOTES="${NOTES}- Windows 10 or later (64-bit)\n"
          NOTES="${NOTES}- Administrator privileges for installation (optional for user-scoped installs)\n"
          NOTES="${NOTES}- Internet connection for downloading PHP versions\n\n"
          NOTES="${NOTES}**Linux:**\n"
          NOTES="${NOTES}- Linux distribution with GTK 3.0+ and WebKitGTK support\n"
          NOTES="${NOTES}- Internet connection for downloading PHP versions\n\n"
          NOTES="${NOTES}### üöÄ Getting Started\n\n"
          NOTES="${NOTES}1. **Install the Application**\n"
          NOTES="${NOTES}   - Run the MSI or Setup executable\n"
          NOTES="${NOTES}   - Follow the installation wizard\n"
          NOTES="${NOTES}   - Launch PHP Version Manager from the Start menu\n\n"
          NOTES="${NOTES}2. **Install Your First PHP Version**\n"
          NOTES="${NOTES}   - Open the \"Available Versions\" tab\n"
          NOTES="${NOTES}   - Select a PHP version to install\n"
          NOTES="${NOTES}   - Wait for download and installation to complete\n\n"
          NOTES="${NOTES}3. **Switch PHP Versions**\n"
          NOTES="${NOTES}   - Go to the \"Installed Versions\" tab\n"
          NOTES="${NOTES}   - Click \"Set Active\" on your desired version\n"
          NOTES="${NOTES}   - The system PATH will be updated automatically\n\n"
          NOTES="${NOTES}### üîí Security\n\n"
          NOTES="${NOTES}- **Checksum Verification**: All downloads are verified for integrity\n"
          NOTES="${NOTES}- **Atomic Operations**: Installations are atomic with rollback support\n"
          NOTES="${NOTES}- **User-Scoped**: No silent privilege escalation required\n"
          NOTES="${NOTES}- **Memory Safe**: Built with Rust for security and reliability\n\n"
          NOTES="${NOTES}### üìù Notes\n\n"
          NOTES="${NOTES}- Memory-safe implementation using Rust\n"
          NOTES="${NOTES}- Low resource footprint for fast startup and minimal memory usage\n"
          NOTES="${NOTES}- All PHP versions are downloaded from official sources\n"
          NOTES="${NOTES}- Cross-platform support for Windows and Linux\n\n"
          NOTES="${NOTES}### üêõ Known Issues\n\n"
          NOTES="${NOTES}None at this time. If you encounter any issues, please report them via the project repository or contact us at php-vm@jmsit.cloud.\n\n"
          NOTES="${NOTES}---\n\n"
          NOTES="${NOTES}**Release Date**: $(date +'%Y-%m-%d')\n"
          NOTES="${NOTES}**Version**: ${VERSION_NUMBER}\n"
          NOTES="${NOTES}**Platform**: Windows x64, Linux x64\n"
          NOTES="${NOTES}**License**: MIT\n"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "${NOTES}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-packages
          path: ./artifacts/linux

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: ${{ contains(env.VERSION, '-') }}
          files: |
            artifacts/windows/**
            artifacts/linux/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}